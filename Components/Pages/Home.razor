@page "/"
@using FoodInspector.Services
@using FoodInspector.Models
@inject IBarcodeScannerService BarcodeScanner
@inject IOcrService OcrService
@inject IOpenFoodFactsService OpenFoodFacts
@inject IIngredientAnalysisService AnalysisService
@inject IDatabaseService DatabaseService
@inject ISettingsService SettingsService
@inject NavigationManager Navigation

<PageTitle>Scan - Food Inspector</PageTitle>

<div class="page-container">
    <h1>Food Safety Scanner</h1>

    @if (isFlareMode)
    {
        <div class="alert alert-danger">
            <strong>üî• Flare Mode Active</strong> - Moderate findings escalate to AVOID.
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>@loadingMessage</p>
        </div>
    }
    else if (currentResult != null)
    {
        <div class="@GetSafetyCardClass(currentResult.SafetyLevel)">
            <h2>@GetSafetyLevelText(currentResult.SafetyLevel)</h2>
            <p><strong>@currentResult.Summary</strong></p>

            <h4>Direct matches</h4>
            @if (currentResult.DirectMatches.Any())
            {
                <ul>
                    @foreach (var match in currentResult.DirectMatches)
                    {
                        <li>@match.TriggerName (@match.Reason) from "@match.MatchedText"</li>
                    }
                </ul>
            }
            else
            {
                <p>No direct matches.</p>
            }

            <h4>Cross-reactive matches</h4>
            @if (currentResult.CrossReactiveMatches.Any())
            {
                @foreach (var match in currentResult.CrossReactiveMatches)
                {
                    <details class="mb-2">
                        <summary>@match.SourceName ‚Üí @match.TriggerName (@match.Strength) - @match.EvidenceCitationShort</summary>
                        <div><strong>Citation:</strong> @match.EvidenceCitationFull</div>
                        <div><strong>Summary:</strong> @match.EvidenceSummary</div>
                    </details>
                }
            }
            else
            {
                <p>No cross-reactive expansions.</p>
            }

            <button class="btn btn-primary mt-3" @onclick="SaveToHistory">Save to History</button>
            <button class="btn btn-secondary mt-3" @onclick="Reset">New Scan</button>
        </div>
    }
    else
    {
        <div class="mb-3">
            <label for="ingredientsInput" class="form-label">Enter Ingredients:</label>
            <textarea class="form-control" id="ingredientsInput" rows="5"
                      @bind="ingredientsText"
                      placeholder="Enter ingredients manually or use scanning options below..."></textarea>
        </div>

        <button class="btn btn-primary scan-button" @onclick="ScanBarcode">üì∑ Scan Barcode</button>
        <button class="btn btn-info scan-button" @onclick="ScanIngredients">üì∏ Scan Ingredients (OCR)</button>
        <button class="btn btn-success scan-button" @onclick="AnalyzeManual">üîç Analyze Ingredients</button>
    }
</div>

@code {
    private string ingredientsText = "";
    private string? currentBarcode;
    private string? currentProductName;
    private AnalysisResult? currentResult;
    private bool isLoading;
    private string loadingMessage = "";
    private bool isFlareMode;
    private int flareModeThreshold = 5;

    protected override async Task OnInitializedAsync()
    {
        await DatabaseService.InitializeDatabaseAsync();
        isFlareMode = await SettingsService.GetFlareModeAsync();
        flareModeThreshold = await SettingsService.GetFlareModeThresholdAsync();
    }

    private async Task ScanBarcode() { await Task.CompletedTask; }
    private async Task ScanIngredients() { await Task.CompletedTask; }

    private async Task AnalyzeManual()
    {
        if (!string.IsNullOrWhiteSpace(ingredientsText))
        {
            await AnalyzeIngredients();
        }
    }

    private async Task AnalyzeIngredients()
    {
        isLoading = true;
        loadingMessage = "Analyzing ingredients...";
        StateHasChanged();

        try
        {
            currentResult = await AnalysisService.AnalyzeIngredientsAsync(ingredientsText, isFlareMode, flareModeThreshold);
        }
        catch (Exception ex)
        {
            currentResult = new AnalysisResult
            {
                SafetyLevel = SafetyLevel.Safe,
                Summary = $"Error analyzing ingredients: {ex.Message}"
            };
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SaveToHistory()
    {
        if (currentResult == null)
        {
            return;
        }

        // Create ScanRecord with associated ScanMatch entities
        // Entity Framework will automatically set ScanRecordId on the ScanMatch entities
        // when SaveChangesAsync is called, due to the configured relationship.
        var record = new ScanRecord
        {
            CreatedUtc = DateTime.UtcNow,
            Barcode = currentBarcode,
            ProductName = currentProductName,
            RawIngredientsText = ingredientsText,
            FinalStatus = currentResult.SafetyLevel,
            FlareModeOn = isFlareMode,
            AnalysisSummary = currentResult.Summary,
            Matches = currentResult.DirectMatches
                .Concat(currentResult.CrossReactiveMatches)
                .Select(x => new ScanMatch
                {
                    TriggerId = x.TriggerId,
                    MatchedText = x.MatchedText,
                    Reason = x.Reason,
                    EvidenceSourceId = x.EvidenceSourceId
                })
                .ToList()
        };

        await DatabaseService.SaveScanHistoryAsync(record);
        Navigation.NavigateTo("/history");
    }

    private void Reset()
    {
        ingredientsText = "";
        currentBarcode = null;
        currentProductName = null;
        currentResult = null;
    }

    private static string GetSafetyCardClass(SafetyLevel level) => level switch
    {
        SafetyLevel.Safe => "safety-card safety-safe",
        SafetyLevel.Caution => "safety-card safety-caution",
        SafetyLevel.Avoid => "safety-card safety-avoid",
        _ => "safety-card"
    };

    private static string GetSafetyLevelText(SafetyLevel level) => level switch
    {
        SafetyLevel.Safe => "‚úÖ SAFE",
        SafetyLevel.Caution => "‚ö†Ô∏è CAUTION",
        SafetyLevel.Avoid => "üö´ AVOID",
        _ => "UNKNOWN"
    };
}
