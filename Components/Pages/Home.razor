@page "/"
@inject IBarcodeScannerService BarcodeScanner
@inject IOcrService OcrService
@inject IOpenFoodFactsService OpenFoodFacts
@inject IIngredientAnalysisService AnalysisService
@inject IDatabaseService DatabaseService
@inject ISettingsService SettingsService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Scan - Food Inspector</PageTitle>

@if (isFlareMode)
{
    <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Class="mb-4" Icon="@Icons.Material.Filled.LocalFireDepartment">
        <MudText Typo="Typo.body1"><strong>Flare Mode Active</strong> - Moderate findings escalate to AVOID.</MudText>
    </MudAlert>
}

@if (isLoading)
{
    <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 300px;">
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        <MudText Typo="Typo.body1" Color="Color.Secondary">@loadingMessage</MudText>
    </MudStack>
}
else if (currentResult != null)
{
    <!-- Product info banner if from barcode -->
    @if (!string.IsNullOrEmpty(currentProductName) || !string.IsNullOrEmpty(currentBarcode))
    {
        <MudPaper Class="pa-3 mb-4" Elevation="1" Style="border-left: 4px solid var(--mud-palette-primary);">
            <MudStack Spacing="1">
                @if (!string.IsNullOrEmpty(currentProductName))
                {
                    <MudText Typo="Typo.subtitle1"><strong>@currentProductName</strong></MudText>
                }
                @if (!string.IsNullOrEmpty(currentBarcode))
                {
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                        <MudIcon Icon="@Icons.Material.Filled.QrCode" Size="Size.Small" Color="Color.Secondary" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary">@currentBarcode</MudText>
                    </MudStack>
                }
            </MudStack>
        </MudPaper>
    }

    <MudCard Elevation="3" Class="mb-4" Style="@GetSafetyCardStyle(currentResult.SafetyLevel)">
        <MudCardHeader>
            <CardHeaderContent>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIcon Icon="@GetSafetyIcon(currentResult.SafetyLevel)" Size="Size.Large" />
                    <MudText Typo="Typo.h4">@GetSafetyLevelText(currentResult.SafetyLevel)</MudText>
                </MudStack>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.body1" Class="mb-4">@currentResult.Summary</MudText>
            <MudSwitch @bind-Value="showImpactInsights"
                       Color="Color.Primary"
                       Label="Show symptom vs inflammation insights"
                       Class="mb-2" />
            @if (showImpactInsights)
            {
                <MudAlert Severity="@GetImpactAlertSeverity(currentResult.ImpactType)" Dense="true" Class="mb-4">
                    <MudText Typo="Typo.body2"><strong>@GetImpactLabel(currentResult.ImpactType):</strong> @currentResult.ImpactExplanation</MudText>
                    @if (!string.IsNullOrWhiteSpace(currentResult.ImpactCitationShort))
                    {
                        <MudText Typo="Typo.caption">Evidence: @currentResult.ImpactCitationShort</MudText>
                    }
                </MudAlert>
            }
            <MudPaper Outlined="true" Class="pa-3 mb-4">
                <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Inflammation Timeline</strong></MudText>
                <MudStack Row="true" Spacing="1" Class="mb-2" Style="flex-wrap: wrap;">
                    <MudChip T="string" Color="@GetTimelineBadgeColor(currentResult.TimelineFlags.Acute)" Variant="Variant.Filled">
                        Acute (0–24h)
                    </MudChip>
                    <MudChip T="string" Color="@GetTimelineBadgeColor(currentResult.TimelineFlags.Subacute)" Variant="Variant.Filled">
                        Subacute (1–7 days)
                    </MudChip>
                    <MudChip T="string" Color="@GetTimelineBadgeColor(currentResult.TimelineFlags.Chronic)" Variant="Variant.Filled">
                        Chronic/Cumulative (weeks+)
                    </MudChip>
                </MudStack>
                @if (currentResult.TimelineBuckets.Any(x => x.IsApplicable))
                {
                    @foreach (var bucket in currentResult.TimelineBuckets.Where(x => x.IsApplicable))
                    {
                        <MudText Typo="Typo.body2"><strong>@bucket.Label:</strong> @bucket.Why</MudText>
                        @if (bucket.EvidenceCitations.Any())
                        {
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Evidence: @string.Join("; ", bucket.EvidenceCitations)</MudText>
                        }
                    }
                }
                else
                {
                    <MudText Typo="Typo.body2" Color="Color.Secondary">No evidence-linked timing profile matched this result.</MudText>
                }
            </MudPaper>

            <MudExpansionPanels MultiExpansion="true">
                <MudExpansionPanel Text="@($"Direct Matches ({currentResult.DirectMatches.Count()})")" 
                                   Icon="@Icons.Material.Filled.Warning"
                                   @bind-Expanded="directMatchesExpanded">
                    @if (currentResult.DirectMatches.Any())
                    {
                        <MudList T="string" Dense="true">
                            @foreach (var match in currentResult.DirectMatches)
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Circle" IconColor="Color.Error">
                                    <MudStack Spacing="0">
                                        <MudText Typo="Typo.body1"><strong>@match.TriggerName</strong></MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @match.Reason - found "@match.MatchedText"
                                        </MudText>
                                    </MudStack>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No direct matches found.</MudText>
                    }
                </MudExpansionPanel>

                <MudExpansionPanel Text="@($"Cross-Reactive Matches ({currentResult.CrossReactiveMatches.Count()})")"
                                   Icon="@Icons.Material.Filled.Share">
                    @if (currentResult.CrossReactiveMatches.Any())
                    {
                        @foreach (var match in currentResult.CrossReactiveMatches)
                        {
                            <MudCard Outlined="true" Class="mb-2">
                                <MudCardContent>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Style="flex-wrap: wrap;">
                                        <MudChip T="string" Color="Color.Primary" Size="Size.Small">@match.SourceName</MudChip>
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Small" />
                                        <MudChip T="string" Color="Color.Secondary" Size="Size.Small">@match.TriggerName</MudChip>
                                        <MudChip T="string" Color="@GetStrengthColor(match.Strength)" Size="Size.Small" Variant="Variant.Outlined">
                                            @match.Strength
                                        </MudChip>
                                    </MudStack>
                                    <MudText Typo="Typo.caption" Class="mt-2">@match.EvidenceCitationShort</MudText>
                                    <MudCollapse @bind-Expanded="@match.IsExpanded">
                                        <MudText Typo="Typo.body2" Class="mt-2"><strong>Citation:</strong> @match.EvidenceCitationFull</MudText>
                                        <MudText Typo="Typo.body2"><strong>Summary:</strong> @match.EvidenceSummary</MudText>
                                    </MudCollapse>
                                    <MudButton Variant="Variant.Text" Size="Size.Small" OnClick="@(() => match.IsExpanded = !match.IsExpanded)">
                                        @(match.IsExpanded ? "Show Less" : "Show More")
                                    </MudButton>
                                </MudCardContent>
                            </MudCard>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No cross-reactive expansions.</MudText>
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Save" OnClick="SaveToHistory">
                Save to History
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Refresh" OnClick="Reset">
                New Scan
            </MudButton>
        </MudCardActions>
    </MudCard>
}
else
{
    <MudText Typo="Typo.h5" Class="mb-4">Food Safety Scanner</MudText>
    
    <MudTextField T="string" 
                  @bind-Value="ingredientsText"
                  Label="Enter Ingredients"
                  Placeholder="Paste or type an ingredient list, or use the buttons below..."
                  Variant="Variant.Outlined"
                  Lines="5"
                  Class="mb-4"
                  FullWidth="true" />

    <MudStack Spacing="3">
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Primary" 
                   StartIcon="@Icons.Material.Filled.QrCodeScanner"
                   FullWidth="true"
                   Size="Size.Large"
                   OnClick="ScanBarcode">
            @if (BarcodeScanner.IsNativeScanSupported)
            {
                <text>Scan Barcode</text>
            }
            else
            {
                <text>Enter Barcode</text>
            }
        </MudButton>
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Info" 
                   StartIcon="@Icons.Material.Filled.DocumentScanner"
                   FullWidth="true"
                   Size="Size.Large"
                   OnClick="ScanIngredients">
            Scan Ingredients (OCR)
        </MudButton>
        
        <MudButton Variant="Variant.Filled" 
                   Color="Color.Success" 
                   StartIcon="@Icons.Material.Filled.Search"
                   FullWidth="true"
                   Size="Size.Large"
                   OnClick="AnalyzeManual"
                   Disabled="@string.IsNullOrWhiteSpace(ingredientsText)">
            Analyze Ingredients
        </MudButton>
    </MudStack>

    <MudDivider Class="my-6" />

    <MudText Typo="Typo.h6" Class="mb-3">Quick Tips</MudText>
    <MudStack Spacing="2">
        <MudAlert Severity="Severity.Info" Dense="true" NoIcon="false">
            Scan a barcode to automatically look up ingredients from Open Food Facts.
        </MudAlert>
        <MudAlert Severity="Severity.Info" Dense="true" NoIcon="false">
            Paste ingredient lists from a website or type them in manually.
        </MudAlert>
        <MudAlert Severity="Severity.Info" Dense="true" NoIcon="false">
            Enable Flare Mode in Settings during sensitive periods.
        </MudAlert>
    </MudStack>
}

@code {
    private string ingredientsText = "";
    private string? currentBarcode;
    private string? currentProductName;
    private AnalysisResult? currentResult;
    private bool isLoading;
    private string loadingMessage = "";
    private bool isFlareMode;
    private int flareModeThreshold = 5;

    protected override async Task OnInitializedAsync()
    {
        await DatabaseService.InitializeDatabaseAsync();
        isFlareMode = await SettingsService.GetFlareModeAsync();
        flareModeThreshold = await SettingsService.GetFlareModeThresholdAsync();
    }

    private async Task ScanBarcode()
    {
        string? barcode = null;

        if (BarcodeScanner.IsNativeScanSupported)
        {
            // Native camera scan on Android/iOS
            // Don't show loading spinner � the native modal page covers the screen
            barcode = await BarcodeScanner.ScanBarcodeAsync();

            if (string.IsNullOrEmpty(barcode))
            {
                Snackbar.Add("No barcode detected. Try again or enter manually.", Severity.Warning);
                return;
            }
        }
        else
        {
            // Windows/desktop fallback: manual entry dialog
            barcode = await ShowBarcodeEntryDialog();
            if (string.IsNullOrEmpty(barcode))
                return;
        }

        await LookupBarcode(barcode);
    }

    private async Task<string?> ShowBarcodeEntryDialog()
    {
        var barcodeValue = "";
        var parameters = new DialogParameters<BarcodeEntryDialog>
        {
            { x => x.BarcodeValue, barcodeValue }
        };
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };
        var dialog = await DialogService.ShowAsync<BarcodeEntryDialog>("Enter Barcode", parameters, options);
        var result = await dialog.Result;

        if (result != null && !result.Canceled && result.Data is string code && !string.IsNullOrWhiteSpace(code))
            return code.Trim();

        return null;
    }

    private async Task LookupBarcode(string barcode)
    {
        currentBarcode = barcode;

        isLoading = true;
        loadingMessage = $"Looking up barcode {barcode}...";
        StateHasChanged();

        var product = await OpenFoodFacts.GetProductByBarcodeAsync(barcode);

        if (product == null || string.IsNullOrWhiteSpace(product.Ingredients))
        {
            isLoading = false;
            StateHasChanged();

            Snackbar.Add("Product not found or no ingredients listed. You can enter them manually.", Severity.Warning);
            return;
        }

        currentProductName = product.Brands != null
            ? $"{product.ProductName} ({product.Brands})"
            : product.ProductName;
        ingredientsText = product.Ingredients;

        Snackbar.Add($"Found: {currentProductName ?? "Unknown product"}", Severity.Success);

        // Auto-analyze
        loadingMessage = "Analyzing ingredients...";
        StateHasChanged();

        currentResult = await AnalysisService.AnalyzeIngredientsAsync(ingredientsText, isFlareMode, flareModeThreshold);
        isLoading = false;
    }

    private async Task ScanIngredients()
    {
        Snackbar.Add("OCR scanning is coming soon. For now, please type or paste ingredients.", Severity.Info);
        await Task.CompletedTask;
    }

    private async Task AnalyzeManual()
    {
        if (!string.IsNullOrWhiteSpace(ingredientsText))
        {
            currentBarcode = null;
            currentProductName = null;
            await AnalyzeIngredients();
        }
    }

    private async Task AnalyzeIngredients()
    {
        isLoading = true;
        loadingMessage = "Analyzing ingredients...";
        StateHasChanged();

        currentResult = await AnalysisService.AnalyzeIngredientsAsync(ingredientsText, isFlareMode, flareModeThreshold);

        isLoading = false;
    }

    private async Task SaveToHistory()
    {
        if (currentResult == null)
            return;

        var record = new ScanRecord
        {
            CreatedUtc = DateTime.UtcNow,
            Barcode = currentBarcode,
            ProductName = currentProductName,
            RawIngredientsText = ingredientsText,
            FinalStatus = currentResult.SafetyLevel,
            FlareModeOn = isFlareMode,
            AnalysisSummary = currentResult.Summary,
            ImpactType = currentResult.ImpactType,
            ImpactExplanation = currentResult.ImpactExplanation,
            ImpactCitationShort = currentResult.ImpactCitationShort,
            Matches = currentResult.DirectMatches
                .Concat(currentResult.CrossReactiveMatches)
                .Select(x => new ScanMatch
                {
                    TriggerId = x.TriggerId,
                    MatchedText = x.MatchedText,
                    Reason = x.Reason,
                    EvidenceSourceId = x.EvidenceSourceId
                })
                .ToList()
        };

        await DatabaseService.SaveScanHistoryAsync(record);
        Snackbar.Add("Saved to history!", Severity.Success);
        Navigation.NavigateTo("/history");
    }

    private void Reset()
    {
        ingredientsText = "";
        currentBarcode = null;
        currentProductName = null;
        currentResult = null;
    }

    private static string GetSafetyCardStyle(SafetyLevel level) => level switch
    {
        SafetyLevel.Safe => "border-left: 4px solid #22C55E; background: linear-gradient(to right, #F0FDF4, white);",
        SafetyLevel.Caution => "border-left: 4px solid #F59E0B; background: linear-gradient(to right, #FFFBEB, white);",
        SafetyLevel.Avoid => "border-left: 4px solid #EF4444; background: linear-gradient(to right, #FEF2F2, white);",
        _ => ""
    };

    private static string GetSafetyIcon(SafetyLevel level) => level switch
    {
        SafetyLevel.Safe => Icons.Material.Filled.CheckCircle,
        SafetyLevel.Caution => Icons.Material.Filled.Warning,
        SafetyLevel.Avoid => Icons.Material.Filled.Dangerous,
        _ => Icons.Material.Filled.Help
    };

    private static string GetSafetyLevelText(SafetyLevel level) => level switch
    {
        SafetyLevel.Safe => "SAFE",
        SafetyLevel.Caution => "CAUTION",
        SafetyLevel.Avoid => "AVOID",
        _ => "UNKNOWN"
    };

    private static Color GetStrengthColor(string? strength) => strength switch
    {
        "High" => Color.Error,
        "Medium" => Color.Warning,
        "Low" => Color.Success,
        _ => Color.Default
    };

    private static Color GetTimelineBadgeColor(bool highlighted) => highlighted ? Color.Primary : Color.Default;
    private static string GetImpactLabel(ImpactType impactType) => impactType switch
    {
        ImpactType.SymptomLikely => "Likely symptom trigger",
        ImpactType.InflammationLikely => "Possible inflammatory trigger",
        _ => "Unknown"
    };

    private static Severity GetImpactAlertSeverity(ImpactType impactType) => impactType switch
    {
        ImpactType.SymptomLikely => Severity.Info,
        ImpactType.InflammationLikely => Severity.Warning,
        _ => Severity.Normal
    };

    private bool directMatchesExpanded = true;
    private bool showImpactInsights = true;
}
